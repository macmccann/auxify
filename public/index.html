<!doctype html>
<html>
    <head>
        <title>Auxify</title>
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <style type="text/css">
            #login, #loggedin {
                display: none;
            }
            .text-overflow {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                width: 500px;
            }
        </style>
    </head>

<body>
    <div class="container">
        <div id="login">
            <h1>Auxify login</h1>
            <a href="/login" class="btn btn-primary">Log in with Spotify</a>
        </div>
        <div id="loggedin">
            <div id="user-profile">
            </div>
        </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
        <h1>Logged in as {{display_name}}</h1>
        <h2>Made a playlist for you called Auxify Playlist!</h2>
        <div class="media">
            <div class="pull-left">
                <img class="media-object" width="150" src="{{images.0.url}}" />
            </div>
            <div class="media-body">
                <dl class="dl-horizontal">
                    <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
                    <dt>Id</dt><dd>{{id}}</dd>
                    <dt>Email</dt><dd>{{email}}</dd>
                    <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
                    <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
                    <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
                    <dt>Country</dt><dd>{{country}}</dd>
                </dl>
            </div>
        </div>
        <p><a href="#" onclick="addAllStar()">Add song 'All Star' by 'Smash Mouth' to playlist</a></p>
        <p><a href="#" onclick="addSandstorm()">Add song 'Sandstorm' by 'Darude' to playlist</a></p>
        <p><a href="#" onclick="addShootingStars()">Add song 'Shooting Stars' by 'Bag Raiders' to playlist</a></p>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
    var webID = null;
    var playlistID = null;
    var playlistURI = null;
    var access_token = null;
    var refresh_token = null;
    var error = null;

    /**
    * Obtains parameters from the hash of the URL
    * @return Object
    */
    function getHashParams() {
        var hashParams = {};
        var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
        while ( e = r.exec(q)) {
            hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
    }

    (function() {
        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
        userProfileTemplate = Handlebars.compile(userProfileSource),
        userProfilePlaceholder = document.getElementById('user-profile');

        var params = getHashParams();

        access_token = params.access_token;
        refresh_token = params.refresh_token;
        error = params.error;

        if (error) {
            alert('There was an error during the authentication');
        } else {
            if (access_token) {


                // ------------------------------------ DO EVERYTHING ELSE HERE!!! ---------------------------------- \\


                // ajax call to retrieve information about the user
                $.ajax({

                    url: 'https://api.spotify.com/v1/me',
                    headers: {
                        'Authorization': 'Bearer ' + access_token
                    }
                }).done(
                    function (response) {
                        webID = response.id;
                        userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                        // ajax call to create the new auxify playlist
                        $.ajax({
                            type: 'POST',
                            url: 'https://api.spotify.com/v1/users/' + webID + '/playlists',
                            headers: {
                                'Authorization': 'Bearer ' + access_token,
                                'Content-Type': "application/json"
                            },
                            data: JSON.stringify({
                                "name" : "Auxify Playlist",
                                "public" : false
                            }),
                        }).done(
                            function(response) {
                                playlistID = response.id;
                                playlistURI = response.uri;


                                // ajax call to add a song to the new playlist
                                $.ajax({
                                    type: 'POST',
                                    url: 'https://api.spotify.com/v1/users/' + webID + '/playlists/' + playlistID + '/tracks',
                                    headers: {
                                        'Authorization': 'Bearer ' + access_token,
                                        'Content-Type': "application/json"
                                    },
                                    data: JSON.stringify({
                                        "uris": ["spotify:track:26IHSipiiSMN7zmwY9CJZS"]
                                    })

                                }).done(
                                    function(response) {
                                        //ajax call to start playing the new playlist
                                        $.ajax({
                                            type: 'PUT',
                                            url: 'https://api.spotify.com/v1/me/player/play',
                                            headers: {
                                                'Authorization': 'Bearer ' + access_token,
                                                'Content-Type': "application/json"
                                            },
                                            data: JSON.stringify({
                                                "context_uri": playlistURI
                                            })
                                        }).done(
                                            function(response) {
                                                console.log(response);
                                                $('#login').hide();
                                                $('#loggedin').show();
                                            }
                                        )
                                    }
                                )
                            }


                        ).fail(
                            function(xhr, status, error) {
                                console.log(xhr.responseText);
                            }
                        );
                    }
                ).fail(
                    //include error message here
                    function () {
                        alert( "auth failed!" );
                    }
                );


// ----------------------------------- SHOW INITIAL SCREEN HERE!!! -------------------------------- \\
            } else {
                // render initial screen
                $('#login').show();
                $('#loggedin').hide();
            }
        }
    })();


// --------------------------------------------- HELPERS ------------------------------------------ \\

    //adds all star to the auxify playlist
    function addAllStar(){
        $.ajax({
            type: 'POST',
            url: 'https://api.spotify.com/v1/users/' + webID +
                '/playlists/' + playlistID + '/tracks',
            headers: {
                'Authorization': 'Bearer ' + access_token,
                'Content-Type': "application/json"
            },
            data: JSON.stringify({
                "uris": ["spotify:track:3cfOd4CMv2snFaKAnMdnvK"]
            })

        })
    }

    //adds sandstorm to the auxify playlist
    function addSandstorm(){
        $.ajax({
            type: 'POST',
            url: 'https://api.spotify.com/v1/users/' + webID +
                '/playlists/' + playlistID + '/tracks',
            headers: {
                'Authorization': 'Bearer ' + access_token,
                'Content-Type': "application/json"
            },
            data: JSON.stringify({
                "uris": ["spotify:track:2SG0RPcyWgUPqLCKWLtYc1"]
            })

        })
    }

    //adds shooting stars to the auxify playlist
    function addShootingStars(){
        $.ajax({
            type: 'POST',
            url: 'https://api.spotify.com/v1/users/' + webID +
                '/playlists/' + playlistID + '/tracks',
            headers: {
                'Authorization': 'Bearer ' + access_token,
                'Content-Type': "application/json"
            },
            data: JSON.stringify({
                "uris": ["spotify:track:0UeYCHOETPfai02uskjJ3x"]
            })

        })
    }

    </script>
    </body>
</html>
